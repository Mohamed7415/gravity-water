<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Real AR Water</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            overflow: hidden;
            touch-action: none;
            font-family: 'Segoe UI', sans-serif;
        }
        canvas { display: block; width: 100%; height: 100%; }
        
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            background: rgba(0,0,0,0.8);
            transition: opacity 0.5s;
        }
        
        /* Controls UI */
        #controls {
            position: absolute;
            bottom: 30px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 20px;
            pointer-events: auto;
            z-index: 10;
        }

        .btn {
            padding: 12px 24px;
            font-size: 16px;
            color: white;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 30px;
            backdrop-filter: blur(10px);
            cursor: pointer;
            text-transform: uppercase;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .btn.active {
            background: #4facfe;
            border-color: #4facfe;
            color: #000;
        }

        #start-btn {
            position: relative; /* Ensure z-index works */
            z-index: 100000;    /* Force on top of everything */
            pointer-events: auto;
            padding: 20px 50px;
            font-size: 24px;
            border: 2px solid #4facfe;
            color: #4facfe;
            background: rgba(0,0,0,0.5); /* Make hit area clear */
            border-radius: 50px;
            cursor: pointer;
        }

        video { display: none; } /* Hidden video element for texture capture */
        
        .hidden { opacity: 0; pointer-events: none !important; }
    </style>
</head>
<body>
    <canvas id="glcanvas"></canvas>
    <video id="cam-video" autoplay playsinline muted></video>

    <div id="ui-layer">
        <button id="start-btn" class="btn">START EXPERIENCE</button>
        <p style="color:#888; margin-top:10px; font-size:12px">Requires Camera & Motion Sensors</p>
    </div>

    <div id="controls" class="hidden">
        <button id="btn-cam" class="btn">Camera: OFF</button>
        <button id="btn-reset" class="btn">Reset</button>
    </div>

    <!-- Debug Log for Mobile -->
    <div id="debug-console" style="position:absolute; top:0; left:0; width:100%; height:150px; pointer-events:none; z-index:9999; color:#0f0; font-size:10px; font-family:monospace; padding:5px; overflow:hidden; text-shadow: 1px 1px 0 #000;"></div>

    <!-- SHADERS -->
    <script id="vs-quad" type="x-shader/x-vertex">
        attribute vec2 a_position;
        varying vec2 v_uv;
        void main() {
            v_uv = a_position * 0.5 + 0.5;
            gl_Position = vec4(a_position, 0.0, 1.0);
        }
    </script>

    <script id="fs-water" type="x-shader/x-fragment">
        precision mediump float;
        uniform sampler2D u_particles; 
        uniform sampler2D u_bg;        
        uniform vec2 u_resolution;
        varying vec2 v_uv;

        void main() {
            vec2 pixel = 1.0 / u_resolution;
            float alpha = texture2D(u_particles, v_uv).a;
            
            // Sharpen edge: Higher threshold, smaller transition
            // 0.6 means "fatter" particles, 0.01 means sharp edge
            float threshold = 0.6;
            
            vec4 bgCol = texture2D(u_bg, v_uv);

            if (alpha < threshold - 0.01) {
                gl_FragColor = bgCol;
                return;
            }

            // High Quality Normals
            float a_r = texture2D(u_particles, v_uv + vec2(pixel.x*2.0, 0.0)).a;
            float a_u = texture2D(u_particles, v_uv + vec2(0.0, pixel.y*2.0)).a;
            
            vec3 normal = normalize(vec3(
                (threshold - a_r) * 10.0, // Stronger normals = more refraction
                (threshold - a_u) * 10.0,
                0.5 // Lower Z = steeper waves
            ));

            // Refraction
            vec2 refractUV = v_uv + normal.xy * 0.05; 
            
            // Chromatic Aberration (RGB Split)
            float r = texture2D(u_bg, refractUV + vec2(0.003, 0.0)).r;
            float g = texture2D(u_bg, refractUV).g;
            float b = texture2D(u_bg, refractUV - vec2(0.003, 0.0)).b;
            vec3 refractedColor = vec3(r, g, b);

            // Lighting
            vec3 lightDir = normalize(vec3(0.2, 0.5, 1.0));
            vec3 viewDir = vec3(0.0, 0.0, 1.0);
            
            // Sharp Specular (Wet look)
            vec3 halfDir = normalize(lightDir + viewDir);
            float spec = pow(max(dot(normal, halfDir), 0.0), 200.0); // Ultra sharp highlight

            // Fresnel
            float fresnel = pow(1.0 - max(dot(viewDir, normal), 0.0), 2.0);
            
            // Volume darkening (thicker water is darker)
            float depth = clamp((alpha - threshold) * 2.0, 0.0, 1.0);
            vec3 waterCol = refractedColor * (1.0 - depth * 0.3); // Darken deep parts
            
            // Add Blue Tint slightly
            waterCol = mix(waterCol, vec3(0.0, 0.5, 1.0), 0.1 * depth);

            vec3 finalColor = waterCol + vec3(1.0)*spec + vec3(0.8)*fresnel*0.3;

            gl_FragColor = vec4(finalColor, 1.0);
        }
    </script>

    <script id="vs-particles" type="x-shader/x-vertex">
        attribute vec2 a_position;
        uniform vec2 u_resolution;
        uniform float u_pointSize;
        void main() {
            vec2 clipSpace = (a_position / u_resolution) * 2.0 - 1.0;
            clipSpace.y *= -1.0;
            gl_Position = vec4(clipSpace, 0.0, 1.0);
            gl_PointSize = u_pointSize;
        }
    </script>

    <script id="fs-particles" type="x-shader/x-fragment">
        precision mediump float;
        void main() {
            vec2 coord = gl_PointCoord * 2.0 - 1.0;
            float dist = dot(coord, coord);
            if (dist > 1.0) discard;
            float alpha = (1.0 - dist);
            alpha = pow(alpha, 2.0);
            gl_FragColor = vec4(0.0, 0.0, 1.0, alpha); // Blue channel irrelevant, we use Alpha
        }
    </script>

    <script src="fluid.js"></script>
</body>
</html>