<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Real AR Water</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            overflow: hidden;
            touch-action: none;
            font-family: 'Segoe UI', sans-serif;
        }
        canvas { display: block; width: 100%; height: 100%; }
        
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            background: rgba(0,0,0,0.8);
            transition: opacity 0.5s;
        }
        
        /* Controls UI */
        #controls {
            position: absolute;
            bottom: 30px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 20px;
            pointer-events: auto;
            z-index: 10;
        }

        .btn {
            padding: 12px 24px;
            font-size: 16px;
            color: white;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 30px;
            backdrop-filter: blur(10px);
            cursor: pointer;
            text-transform: uppercase;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .btn.active {
            background: #4facfe;
            border-color: #4facfe;
            color: #000;
        }

        #start-btn {
            padding: 20px 50px;
            font-size: 24px;
            border: 2px solid #4facfe;
            color: #4facfe;
            background: transparent;
            border-radius: 50px;
            cursor: pointer;
        }

        video { display: none; } /* Hidden video element for texture capture */
        
        .hidden { opacity: 0; pointer-events: none !important; }
    </style>
</head>
<body>
    <canvas id="glcanvas"></canvas>
    <video id="cam-video" autoplay playsinline muted></video>

    <div id="ui-layer">
        <button id="start-btn" class="btn">START EXPERIENCE</button>
        <p style="color:#888; margin-top:10px; font-size:12px">Requires Camera & Motion Sensors</p>
    </div>

    <div id="controls" class="hidden">
        <button id="btn-cam" class="btn">Camera: OFF</button>
        <button id="btn-reset" class="btn">Reset</button>
    </div>

    <!-- SHADERS -->
    <script id="vs-quad" type="x-shader/x-vertex">
        attribute vec2 a_position;
        varying vec2 v_uv;
        void main() {
            v_uv = a_position * 0.5 + 0.5;
            gl_Position = vec4(a_position, 0.0, 1.0);
        }
    </script>

    <script id="fs-water" type="x-shader/x-fragment">
        precision mediump float;
        uniform sampler2D u_particles; // The Metaballs (Alpha)
        uniform sampler2D u_bg;        // The Background (Camera or Image)
        uniform vec2 u_resolution;
        varying vec2 v_uv;

        void main() {
            vec2 pixel = 1.0 / u_resolution;
            
            // 1. Get Water Depth/Mask
            float alpha = texture2D(u_particles, v_uv).a;
            
            // Cutoff for sharp surface
            float threshold = 0.45;
            
            // Background is always drawn, but distorted
            vec4 bgCol = texture2D(u_bg, v_uv); // Default background

            if (alpha < threshold) {
                // No water here, just draw background
                gl_FragColor = bgCol;
                return;
            }

            // 2. Calculate Normal (Surface Slope)
            // Smooth normal for better refraction
            float a_r = texture2D(u_particles, v_uv + vec2(pixel.x, 0.0)).a;
            float a_u = texture2D(u_particles, v_uv + vec2(0.0, pixel.y)).a;
            
            vec3 normal = normalize(vec3(
                (threshold - a_r) * 3.0,
                (threshold - a_u) * 3.0,
                0.2 // Lower Z = steeper waves
            ));

            // 3. Realistic Refraction (Distortion)
            // Offset UV based on normal XY
            vec2 refractUV = v_uv + normal.xy * 0.08; // 0.08 strength
            
            // Chromatic Aberration (Split RGB slightly for realism)
            float r = texture2D(u_bg, refractUV + vec2(0.002, 0.0)).r;
            float g = texture2D(u_bg, refractUV).g;
            float b = texture2D(u_bg, refractUV - vec2(0.002, 0.0)).b;
            vec3 refractedColor = vec3(r, g, b);

            // 4. Lighting (Specular + Fresnel)
            vec3 lightDir = normalize(vec3(0.5, 1.0, 1.0));
            vec3 viewDir = vec3(0.0, 0.0, 1.0);
            
            // Specular Highlight (The Sun/Light source reflection)
            vec3 halfDir = normalize(lightDir + viewDir);
            float specAngle = max(dot(normal, halfDir), 0.0);
            float specular = pow(specAngle, 80.0); // Sharp highlight

            // Fresnel (Edges are more reflective/white)
            float fresnel = pow(1.0 - max(dot(viewDir, normal), 0.0), 3.0);
            
            // 5. Compose
            // Water isn't blue, it filters light. But we add a TINY tint.
            // Mix Refracted Background + Highlights
            
            vec3 finalColor = refractedColor;
            
            // Add subtle darkening for "volume" (Beer's law fake)
            finalColor *= 0.95; 

            // Add Highlights
            finalColor += vec3(1.0) * specular * 0.9;
            finalColor += vec3(1.0) * fresnel * 0.4;

            gl_FragColor = vec4(finalColor, 1.0);
        }
    </script>

    <script id="vs-particles" type="x-shader/x-vertex">
        attribute vec2 a_position;
        uniform vec2 u_resolution;
        uniform float u_pointSize;
        void main() {
            vec2 clipSpace = (a_position / u_resolution) * 2.0 - 1.0;
            clipSpace.y *= -1.0;
            gl_Position = vec4(clipSpace, 0.0, 1.0);
            gl_PointSize = u_pointSize;
        }
    </script>

    <script id="fs-particles" type="x-shader/x-fragment">
        precision mediump float;
        void main() {
            vec2 coord = gl_PointCoord * 2.0 - 1.0;
            float dist = dot(coord, coord);
            if (dist > 1.0) discard;
            float alpha = (1.0 - dist);
            alpha = pow(alpha, 2.0);
            gl_FragColor = vec4(0.0, 0.0, 1.0, alpha); // Blue channel irrelevant, we use Alpha
        }
    </script>

    <script src="fluid.js"></script>
</body>
</html>