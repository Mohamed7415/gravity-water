<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Real AR Water</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            overflow: hidden;
            touch-action: none;
            font-family: 'Segoe UI', sans-serif;
        }
        canvas { display: block; width: 100%; height: 100%; }
        
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            background: rgba(0,0,0,0.8);
            transition: opacity 0.5s;
        }
        
        /* Controls UI */
        #controls {
            position: absolute;
            bottom: 30px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 20px;
            pointer-events: auto;
            z-index: 10;
        }

        .btn {
            padding: 12px 24px;
            font-size: 16px;
            color: white;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 30px;
            backdrop-filter: blur(10px);
            cursor: pointer;
            text-transform: uppercase;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .btn.active {
            background: #4facfe;
            border-color: #4facfe;
            color: #000;
        }

        #start-btn {
            position: relative; /* Ensure z-index works */
            z-index: 100000;    /* Force on top of everything */
            pointer-events: auto;
            padding: 20px 50px;
            font-size: 24px;
            border: 2px solid #4facfe;
            color: #4facfe;
            background: rgba(0,0,0,0.5); /* Make hit area clear */
            border-radius: 50px;
            cursor: pointer;
        }

        video { display: none; } /* Hidden video element for texture capture */
        
        .hidden { opacity: 0; pointer-events: none !important; }
    </style>
</head>
<body>
    <canvas id="glcanvas"></canvas>
    <video id="cam-video" autoplay playsinline muted></video>

    <div id="ui-layer">
        <button id="start-btn" class="btn">START EXPERIENCE</button>
        <p style="color:#888; margin-top:10px; font-size:12px">Requires Camera & Motion Sensors</p>
    </div>

    <div id="controls" class="hidden">
        <button id="btn-cam" class="btn">Camera: OFF</button>
        <button id="btn-reset" class="btn">Reset</button>
        <!-- New Sliders -->
        <div style="display:flex; flex-direction:column; gap:10px; margin-left:15px;">
            <label style="color:white; font-size:12px;">Thickness: <input type="range" id="val-thickness" min="0" max="0.3" step="0.01" value="0.15"></label>
            <label style="color:white; font-size:12px;">Density: <input type="range" id="val-density" min="0" max="3.0" step="0.1" value="1.5"></label>
        </div>
    </div>

    <!-- Debug Log for Mobile -->
    <div id="debug-console" style="position:absolute; top:0; left:0; width:100%; height:50px; pointer-events:none; z-index:9999; color:#0f0; font-size:10px; font-family:monospace; padding:5px; overflow:hidden; opacity:0.5;"></div>

    <!-- SHADERS -->
    <script id="vs-quad" type="x-shader/x-vertex">
        attribute vec2 a_position;
        varying vec2 v_uv;
        void main() {
            v_uv = a_position * 0.5 + 0.5;
            gl_Position = vec4(a_position, 0.0, 1.0);
        }
    </script>

    <script id="fs-water" type="x-shader/x-fragment">
        precision mediump float;
        uniform sampler2D u_particles; 
        uniform sampler2D u_bg;        
        uniform vec2 u_resolution;
        
        // Dynamic Parameters
        uniform float u_refractionStr; // Thickness
        uniform float u_density;       // Color Absorption
        
        varying vec2 v_uv;

        void main() {
            vec2 pixel = 1.0 / u_resolution;
            float alpha = texture2D(u_particles, v_uv).a;
            
            // Smoother threshold for "meniscus" effect
            // Instead of hard cut at 0.6, we smooth between 0.5 and 0.65
            float surface = smoothstep(0.4, 0.65, alpha);
            
            if (surface < 0.01) {
                gl_FragColor = texture2D(u_bg, v_uv);
                return;
            }

            // High Quality Normals
            // Using a wider sample radius for "thicker" feeling normals
            float a_r = texture2D(u_particles, v_uv + vec2(pixel.x*3.0, 0.0)).a;
            float a_u = texture2D(u_particles, v_uv + vec2(0.0, pixel.y*3.0)).a;
            
            vec3 normal = normalize(vec3(
                (alpha - a_r) * 8.0, 
                (alpha - a_u) * 8.0,
                0.3 // Z scale determines flatness. Lower = more bumpy.
            ));

            // Volumetric Refraction
            // The deeper the water (higher alpha), the more it refracts
            vec2 refractUV = v_uv + normal.xy * u_refractionStr * alpha; 
            
            // Chromatic Aberration (Thick glass effect)
            float shift = 0.005 * u_refractionStr * 10.0;
            float r = texture2D(u_bg, refractUV + vec2(shift, 0.0)).r;
            float g = texture2D(u_bg, refractUV).g;
            float b = texture2D(u_bg, refractUV - vec2(shift, 0.0)).b;
            vec3 bgCol = vec3(r, g, b);

            // Lighting
            vec3 lightDir = normalize(vec3(0.2, 0.5, 1.0));
            vec3 viewDir = vec3(0.0, 0.0, 1.0);
            
            // Specular
            vec3 halfDir = normalize(lightDir + viewDir);
            float spec = pow(max(dot(normal, halfDir), 0.0), 100.0);

            // Fresnel (Edge reflection)
            float fresnel = pow(1.0 - max(dot(viewDir, normal), 0.0), 3.0);
            
            // Beer's Law (Volume Absorption)
            // Light gets absorbed as it travels through the "thickness" (simulated by alpha)
            // We absorb Red and Green more than Blue to get water color.
            vec3 absorptionColor = vec3(0.9, 0.6, 0.2); // Absorb Red/Green heavily
            vec3 transmission = exp(-absorptionColor * alpha * u_density);
            
            // Compose
            vec3 finalColor = bgCol * transmission; 
            
            // Add reflections on top
            finalColor += vec3(1.0) * spec;
            finalColor += vec3(0.8, 0.9, 1.0) * fresnel * 0.5;

            // Soft edges mixing
            gl_FragColor = vec4(finalColor, 1.0);
        }
    </script>

    <script id="vs-particles" type="x-shader/x-vertex">
        attribute vec2 a_position;
        uniform vec2 u_resolution;
        uniform float u_pointSize;
        void main() {
            vec2 clipSpace = (a_position / u_resolution) * 2.0 - 1.0;
            clipSpace.y *= -1.0;
            gl_Position = vec4(clipSpace, 0.0, 1.0);
            gl_PointSize = u_pointSize;
        }
    </script>

    <script id="fs-particles" type="x-shader/x-fragment">
        precision mediump float;
        void main() {
            vec2 coord = gl_PointCoord * 2.0 - 1.0;
            float dist = dot(coord, coord);
            if (dist > 1.0) discard;
            float alpha = (1.0 - dist);
            alpha = pow(alpha, 2.0);
            gl_FragColor = vec4(0.0, 0.0, 1.0, alpha); // Blue channel irrelevant, we use Alpha
        }
    </script>

    <script src="fluid.js"></script>
</body>
</html>